+++
author = "すかい"
title = "ESXi6.5まとめ"
date = "2017-06-12"
description = "ESXi6.5まとめ"
tags = [
    "ESXi",
]
+++

ESXi6.5を使い始めるにあたって気になった点とか使って困った点とかのまとめ

## インストール前の話

### 利用料金

無償版か有償版か選べる
ただし無償版でもVMwareに登録必須
登録するとライセンスキーが発行される
インストーラーは一緒だけど無償版のライセンスキーをいれない場合は30日の体験版扱いになる

### 機器

出来れば公式で対応を謳っているものを使用した方がトラブルは少ない（らしい
今回は公式対応が表明されているものを利用した
自分でドライバを追加して使うことも出来るようなのでその辺は調べてみて下さい

### 管理

6.5から？WebUIに統一されたようです
5.5時代にお世話になっていたVSphereでアクセスすると一部機能が使えないなどWebUI推奨なようです

### インストールイメージ

もし公式が対応を歌っている製品の場合はそのメーカーが専用のカスタムイメージを配布している場合があるので探すことを推奨する
なければ公式のをインストール
インストールメディアはCD・DVDなどのディスクにダウンロードしたisoを焼くかUSB等のメディアもBIOSが対応していれば使える
今回はUnetbootinを利用しました

### RAID

ハードウェアRAIDしか対応していないそうです
今回はソフトウェアRAIDしか用意できなかったため諦めました

## インストール後の話

### 再インストールしたい

一般のディストリビューションならインストール時にパーティション構成が変更出来ますがESXiの場合既にインストールしていることを検知すると上書きでしかインストールできない様子
ファイル破損時とかには便利かもしれない
一度クリーンにしたい状況になったので他のディストリビューションを利用してパーティションを再構成しました

### NICが1つしか認識しない

今回公式対応のNICを2つ用意して構築しましたが初回インストール時はなぜか1つしか認識しませんでした
NIC2つにLANケーブルを指した状態で再度インストールを行うことで認識されました
※一応SSHで入って確認すると認識はしてるようですが管理画面の選択リストに表示されませんでした

### ライセンスキーを入力したい

メンテナンスモードに変更して入力

### ファイル転送時などにエラーが出て転送出来ない

IP直打ちでログインしているとそういったことが起きるようです
DNSサーバーを置くかローカルのhostsファイルの編集で適当な名前を与えて接続することで解消

### SSH接続したい

トップ画面から有効にしてSSHログイン
デフォルトならrootで22番ポートから入れます
Teratermの場合はチャレンジレスポンス認証です
使う時だけオンにした方が良さ気

### ドメイン名をなんとかしたい

デフォルトだとlocalhost.localdomainになっていてかっこ悪いです
SSHを有効にしてログインし

```
# esxcli system hostname set --host="esxi" --domain="hoge"
or
# esxcli system hostname set --host="esxi"
```

などとして設定できます

### VM名を変更したい

WebUIから変更出来ますがその場合は表示名のみ変更されます
実ファイルがあるディレクトリ名は変わらないため今後不都合が生じる可能性があります
例）hogeからfugaに変える場合
予めVMは停止しておきます

```
# cd /vmfs/volumes/datastore1/
# cd hoge
# vmkfstools -E hoge_0.vmdk fuga_0.vmdk
# cp -p hoge.vmx fuga.vmx //念のためコピーします
# vi fuga.vmx
hogeで始まる内容をfugaで置き換えます
# mv hoge.nvram fuga.nvram
# mv hoge.vmsd fuga.vmsd
# ../
# mv hoge fuga
```

VMを起動させ問題がないことを確認しhoge.vmxを削除して終了です

### Snapshotの自動化

無償版だと良い手がなさそうなのでおとなしくghettoVCBを利用するのが良さそう
https://github.com/lamw/ghettoVCB

### システムが上がらない場合のレスキュー方法

PCパーツ故障で起動しなくなったのでデータのサルベージをしたくなった
適当にUbuntuが稼働してるPCにHDDを接続して

```
# apt-get install vmfs-tools
パッケージを入れた後にマウントする
fdiskとかgpartedとかでデバイスのパスは探す 多分大きいので初期設定を自分でやってればわかる

# vmfs-fuse /dev/sdb /mnt
# cd /mnt
# ls
ずらー
```

あとは必要そうなデータを引っ張ってくる
コマンドでやればいいけどroot権がいるのでGUIのファイルエクスプローラーで見ても中身が見れないので注意
どうしてもGUIで見たい時はファイルマネージャーをroot権で起動する

```
$ sudo nautilus /mnt
```

とかすれば見れる D&Dでファイル移動とかコピーしたい場合は2つ目のウィンドウも同様の方法で開くこと

### 管理画面にエラーが出てアクセス出来ない（Chrome）

AngularJSの仕様でエラーが出るっぽいです
修正されたとか修正されてないとか良く分からんのでとりあえずFirefoxを使って誤魔化してます
